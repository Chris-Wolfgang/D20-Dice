name: Build All Versioned Docs

# One-shot (or on-demand) workflow that builds DocFX documentation for every
# specified version from its matching git tag and deploys the output to
# gh-pages under versions/<version>/.
#
# Versions without a docfx_project at their tag (e.g. v0.1.x) use the
# current docfx_project configuration so that the documentation structure
# is consistent across all versions.

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy All Versioned Docs
    runs-on: windows-latest

    permissions:
      contents: write # Required to push to gh-pages branch

    steps:
      - name: Checkout repository (full history + all tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history so all tags are reachable

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            5.0.x
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Install DocFX
        run: dotnet tool update docfx --global
        shell: pwsh

      - name: Build docs for each version
        id: build
        shell: pwsh
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP 'all_version_docs'
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          # Versions to build – each must have a matching git tag.
          # 'latest' is built from the current HEAD at the end of this step.
          $versions = @('v0.1.0', 'v0.1.1', 'v0.1.2', 'v0.2.0', 'v0.3.0')

          # Remember the original commit so we can restore docfx_project files
          # that are absent from older tags.
          $originalSHA = git rev-parse HEAD

          foreach ($version in $versions) {
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host "Building docs for $version" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan

            $workDir = Join-Path $env:RUNNER_TEMP "workdir-$version"

            # Clean up any leftover worktree from a previous run
            git worktree remove $workDir --force 2>&1 | Out-Null
            if (Test-Path $workDir) { Remove-Item $workDir -Recurse -Force }

            # Create a worktree checked out at the version tag
            git worktree add $workDir $version
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "⚠️  Failed to create worktree for $version – skipping."
              continue
            }

            # Overlay the current docfx_project config so that older tags
            # (which may lack docfx_project/) still produce consistent docs.
            if (Test-Path 'docfx_project') {
              if (Test-Path "$workDir/docfx_project") {
                Remove-Item "$workDir/docfx_project" -Recurse -Force
              }
              Copy-Item 'docfx_project' "$workDir/docfx_project" -Recurse -Force
            }

            # Also copy build-support files that were added in later versions
            # to help older code compile cleanly.
            foreach ($f in @('Directory.Build.props', '.globalconfig', 'BannedSymbols.txt')) {
              if ((Test-Path $f) -and -not (Test-Path "$workDir/$f")) {
                Copy-Item $f "$workDir/$f" -Force
              }
            }

            Push-Location $workDir
            try {
              # Attempt dotnet restore + build; failures are non-fatal because
              # DocFX can still extract metadata from source files.
              $slnFile = Get-ChildItem -Filter '*.sln' -ErrorAction SilentlyContinue |
                         Select-Object -First 1
              if ($slnFile) {
                Write-Host "Restoring $($slnFile.Name)..."
                dotnet restore $slnFile.FullName 2>&1 | Write-Host
                Write-Host "Building $($slnFile.Name)..."
                dotnet build $slnFile.FullName --configuration Release --no-restore 2>&1 | Write-Host
              }

              Write-Host "Running docfx metadata..."
              docfx metadata docfx_project/docfx.json 2>&1 | Write-Host

              Write-Host "Running docfx build..."
              docfx build docfx_project/docfx.json 2>&1 | Write-Host

              if (Test-Path 'docfx_project/_site') {
                $dest = Join-Path $outDir $version
                New-Item -ItemType Directory -Force -Path $dest | Out-Null
                Copy-Item 'docfx_project/_site/*' $dest -Recurse -Force
                Write-Host "✅ Docs built for $version" -ForegroundColor Green
              } else {
                Write-Warning "⚠️  No _site output produced for $version."
              }
            } finally {
              Pop-Location
              git worktree remove $workDir --force 2>&1 | Out-Null
            }
          }

          # Build 'latest' from the current HEAD (the branch this workflow runs on)
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "Building docs for latest" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan

          dotnet restore
          dotnet build --configuration Release --no-restore

          docfx metadata docfx_project/docfx.json
          docfx build docfx_project/docfx.json

          if (Test-Path 'docfx_project/_site') {
            $dest = Join-Path $outDir 'latest'
            New-Item -ItemType Directory -Force -Path $dest | Out-Null
            Copy-Item 'docfx_project/_site/*' $dest -Recurse -Force
            Write-Host "✅ Docs built for latest" -ForegroundColor Green
          } else {
            Write-Error "❌ No _site output for latest build."
            exit 1
          }

      - name: Generate versions.json for every version
        # Writes a versions.json (consumed by the version-switcher dropdown) into
        # each version's output directory.  All URLs are rooted under versions/.
        shell: pwsh
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          $outDir = Join-Path $env:RUNNER_TEMP 'all_version_docs'

          $repoName = ($env:GITHUB_REPOSITORY -split '/')[-1]
          $base = if ($repoName) { "/$repoName/" } else { "/" }

          $semverRe = '^v(?<major>0|[1-9]\d*)\.(?<minor>0|[1-9]\d*)\.(?<patch>0|[1-9]\d*)(?:-(?<prerelease>[0-9A-Za-z.-]+))?$'
          $tags = git tag -l 'v*' | Where-Object { $_ -ne '' }

          $taggedVersions = foreach ($t in $tags) {
            if ($t -match $semverRe) {
              $stable = if ([string]::IsNullOrEmpty($Matches['prerelease'])) { 1 } else { 0 }
              [PSCustomObject]@{
                Tag    = $t
                Major  = [int]$Matches['major']
                Minor  = [int]$Matches['minor']
                Patch  = [int]$Matches['patch']
                Stable = $stable
              }
            }
          }

          $orderedTags = $taggedVersions |
            Sort-Object -Property Major, Minor, Patch, Stable -Descending |
            Select-Object -ExpandProperty Tag

          [array]$versions = @([PSCustomObject]@{ version = 'latest'; url = "${base}versions/latest/" })
          foreach ($t in $orderedTags) {
            $versions += [PSCustomObject]@{ version = $t; url = "${base}versions/$t/" }
          }

          $versionsJson = ConvertTo-Json -InputObject $versions -Depth 3

          Get-ChildItem -Path $outDir -Directory | ForEach-Object {
            $versionsJson | Set-Content -Path (Join-Path $_.FullName 'versions.json') -Encoding utf8NoBOM
            Write-Host "Wrote versions.json to $($_.Name)/"
          }

          Write-Host "Generated versions.json with $($versions.Count) entries: $($versions | ForEach-Object { $_.version })"

      - name: Deploy all versioned docs to gh-pages under versions/
        # Publishes the entire all_version_docs/ output directory to gh-pages
        # as the versions/ sub-directory.  keep_files: true preserves any
        # other content already present on the branch (CNAME, root assets, etc.).
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ runner.temp }}/all_version_docs
          destination_dir: versions
          keep_files: true
          force_orphan: false
